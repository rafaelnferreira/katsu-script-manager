<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <style>
        .odd-colours:nth-child(even) {
            background-color: #f9f9f9;
        }

        .custom-row {
            padding: 10px 0 10px 0;
        }

        .custom-container {
            margin: 50px 0 50px 0;
        }

        .red {
            color: #d9534f;
        }

        .hidden {
            visibility: hidden;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="row" style="border-bottom: 2px solid #ddd;">
            <div class="col-md-6">
                <h4><b>Job name</b></h4>
            </div>
            <div class="col-md-6">
                <h4><b>Actions</b></h4>
            </div>
        </div>
        {{#each jobs}}
        <div class="row odd-colours custom-row">
            <div class="col-md-6">
                {{this.name}}<br>
            </div>
            <div class="col-md-6">
                <input id="{{this.jobName}}-button" data-jobName="{{this.jobName}}" data-branch="{{this.branch}}" class="btn btn-warning open-areYouSureModal" type="submit" data-toggle="modal"
                    data-target="#areYouSureModal">
                <p id="{{this.jobName}}-msg" class="hidden red">

                </p>
            </div>


        </div>
        {{/each}}


    </div>

    <script>
        function postExecJob(jobName, branch) {

            const postRequest = {
                jobName: jobName,
                branch: branch
            }

            const xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function () {

                if (xhttp.readyState === XMLHttpRequest.DONE) {
                    if (status === 0 || (200 >= status && status < 400)) {
                        const successMessage = `The request has been sent successfully.`;
                        hideDeployButton(jobName);
                        displayMessage(jobName, successMessage);
                    } else {
                        const errMessage = `An Error has occurred`;
                        displayMessage(jobName, errMessage);
                    }
                }
            };

            xhttp.open('POST', '/exec-job');
            xhttp.setRequestHeader("Content-type", "application/json");
            xhttp.send(JSON.stringify(postRequest));
        }

        function displayMessage(jobName, message) {
            const msg = document.getElementById(jobName + '-msg');
            const isHidden = msg.classList.contains("hidden");

            msg.innerHTML = message;
            if (isHidden) {
                msg.classList.remove("hidden");
            }
        }

        function hideDeployButton(jobName) {
            const button = document.getElementById(jobName + '-button');
            button.classList.add("hidden");
        }
    </script>

    <!-- Are you sure Modal -->
    <div class="modal fade" id="areYouSureModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="exampleModalLabel">Are you very very sure?????</h3>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    It will take approximately 10 minutes to deploy the app. The deploy button
                    will be disabled, refresh the page and try again in 10 minutes if it didn't work
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger deploy-btn" value="Deploy" data-dismiss="modal">Deploy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal script -->
    <script>
        $(document).on("click", ".open-areYouSureModal", function () {
            const jobName = $(this).data('jobname');
            const branch = $(this).data('branch');

            $('.deploy-btn').on('click', function() {
                postExecJob(jobName, branch);
            });
        });
    </script>
</body>

</html>